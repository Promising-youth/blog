<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>文章详情</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../static/css/article_alter.css" />
    <!-- highlight 的主题-->
    <link
      href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow-night-eighties.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="ping"></div>
    <div id="content">
      <div id="mark_body">
        <input hidden id="article_id" :value="article._id" />
        <div id="mark_left">
          <div id="mark_title">
            <input id="mark_input_title" :value="article.title" />
          </div>
          <div id="mark_menu"></div>
          <textarea
            class="mark_textarea"
            id="mark_edit"
            v-on:keyup="render"
            v-on:keydown="keydown"
          >
{{article.content}}</textarea
          >
        </div>
        <div id="mark_right" v-html="article.md_preview">
          {{article.md_preview}}
        </div>
      </div>
    </div>
    <!--[if lt IE 7]>
      <p class="browsehappy">
        You are using an <strong>outdated</strong> browser. Please
        <a href="#">upgrade your browser</a> to improve your experience.
      </p>
    <![endif]-->
    <!-- vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/vue@2.6.0" async defer></script>-->
    <!-- #vue# 为了不繁琐，使用双#号表示注释的结束-->
    <!-- bootrstrap -->
    <script
      src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.bootcss.com/axios/0.19.2/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

    <script>
      $(function() {
        marked.setOptions({
          renderer: new marked.Renderer(),
          highlight: function(code) {
            return hljs.highlightAuto(code).value;
          },
          pedantic: false,
          gfm: true,
          tables: true,
          breaks: false,
          sanitize: false,
          smartLists: true,
          smartypants: false,
          xhtml: false
        });

        var axios_i = axios.create({
          timeout: 10000,
          withCredentials: true,
          headers: {
            "Content-Type": "application/json"
          }
        });

        axios.defaults.withCredentials = true;
        getUrlParam = function(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
          var r = window.location.search.substr(1).match(reg);
          if (r != null) return unescape(r[2]);
          return null;
        };

        function ping(success, error) {
          axios_i
            .get("http://localhost:80/admin/ping")
            .then(success)
            .catch(error);
        }

        axios_i.post(
          "http://localhost:80/admin/article/5dca1c99008bb1bb000709fd",
          {
            title: "ha",
            content: "hei"
          }
        );

        ping(
          response => {
            this.info = response.data;
            var mark_body = new Vue({
              el: "#mark_body",
              data() {
                return {
                  article: null
                };
              },
              mounted() {
                var id = getUrlParam("id");
                axios_i
                  .get("http://localhost:80/article/get/" + id)
                  .then(response => {
                    this.article = response.data.data;
                    this.article.md_preview = marked(this.article.content);
                  });
              },
              methods: {
                render: function(event) {
                  val = $("#mark_edit").val();
                  $("#mark_right").html(marked(val));
                },
                keydown: function(e) {
                  if (
                    e.keyCode == 83 &&
                    (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)
                  ) {
                    e.preventDefault();
                    // TODO save article
                    var title = $("#mark_input_title").val();
                    var content = $("#mark_edit").val();
                    var id = $("#article_id").val();
                    console.log(title, id, content);

                    axios_i.get("http://localhost:80/admin/ping");

                    axios_i.post(
                      "http://localhost:80/admin/article/" + id,
                      {
                        title: title,
                        content: content
                      },
                      {
                        headers: {
                          Cookie: document.cookie
                        }
                      }
                    );
                    return;
                  }

                  if (e.keyCode == 9) {
                    // get caret position/selection
                    // 原来的this 需要使用e.target来获取
                    var mthis = e.target;
                    var start = mthis.selectionStart;
                    var end = mthis.selectionEnd;
                    var $this = $(mthis);
                    var value = $this.val();
                    // set textarea value to: text before caret + tab + text after caret
                    $this.val(
                      value.substring(0, start) + "\t" + value.substring(end)
                    );
                    // put caret at right position again (add one for the tab)
                    mthis.selectionStart = mthis.selectionEnd = start + 1;
                    // prevent the focus lose
                    e.preventDefault();
                  }
                }
              }
            });
          },
          error => {
            alert(error);
            // 跳转登录,后续再做优化
            location.href =
              "https://github.com/login/oauth/authorize?client_id=eccd2bd134009643887a";
          }
        );
      });
    </script>
    <!-- #bootrstrap# -->
  </body>
</html>
